<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>Admin | TP Enfermería</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&display=swap" rel="stylesheet">
  <style>
    :root{ 
      --bg:#f8fafc; 
      --card:#fff; 
      --text:#0f172a; 
      --muted:#64748b; 
      --primary:#3b82f6; 
      --primary-700:#1d4ed8; 
      --primary-50:#eff6ff;
      --success:#10b981;
      --warning:#f59e0b;
      --danger:#ef4444;
      --line:#e2e8f0;
      --shadow-sm:0 1px 2px 0 rgba(0,0,0,0.05);
      --shadow:0 4px 6px -1px rgba(0,0,0,0.1),0 2px 4px -1px rgba(0,0,0,0.06);
      --shadow-lg:0 10px 15px -3px rgba(0,0,0,0.1),0 4px 6px -2px rgba(0,0,0,0.05);
      --shadow-xl:0 20px 25px -5px rgba(0,0,0,0.1),0 10px 10px -5px rgba(0,0,0,0.04);
    }
    *{box-sizing:border-box}
    html,body{margin:0;font-family:Inter,system-ui,sans-serif;color:var(--text);background:linear-gradient(135deg,#f8fafc 0%,#e2e8f0 100%);min-height:100vh}
    .container{max-width:1200px;margin:20px auto;padding:0 20px}
    .card{background:#fff;border:1px solid var(--line);border-radius:16px;box-shadow:var(--shadow);padding:24px;transition:all 0.3s ease;position:relative;overflow:hidden}
    .card:hover{transform:translateY(-2px);box-shadow:var(--shadow-lg)}
    .card::before{content:'';position:absolute;top:0;left:0;right:0;height:4px;background:linear-gradient(90deg,var(--primary),var(--success));opacity:0;transition:opacity 0.3s ease}
    .card:hover::before{opacity:1}
    
    .btn{display:inline-flex;align-items:center;gap:8px;padding:12px 16px;border:none;border-radius:10px;text-decoration:none;color:var(--text);font-weight:600;background:#fff;cursor:pointer;transition:all 0.3s ease;box-shadow:var(--shadow-sm);position:relative;overflow:hidden}
    .btn::before{content:'';position:absolute;top:0;left:-100%;width:100%;height:100%;background:linear-gradient(90deg,transparent,rgba(255,255,255,0.2),transparent);transition:left 0.5s ease;z-index:1}
    .btn:hover::before{left:100%}
    .btn:hover{transform:translateY(-2px);box-shadow:var(--shadow-lg);color:var(--text)}
    .btn.primary{background:linear-gradient(135deg,var(--primary),var(--primary-700));color:#fff;box-shadow:var(--shadow);position:relative;z-index:2}
    .btn.primary:hover{background:linear-gradient(135deg,var(--primary-700),#1e40af);box-shadow:var(--shadow-lg);color:#fff}
    .btn.danger{background:linear-gradient(135deg,var(--danger),#dc2626);color:#fff;box-shadow:var(--shadow);position:relative;z-index:2}
    .btn.danger:hover{background:linear-gradient(135deg,#dc2626,#b91c1c);box-shadow:var(--shadow-lg);color:#fff}
    .btn.success{background:linear-gradient(135deg,var(--success),#059669);color:#fff;box-shadow:var(--shadow);position:relative;z-index:2}
    .btn.success:hover{background:linear-gradient(135deg,#059669,#047857);box-shadow:var(--shadow-lg);color:#fff}
    .btn.warning{background:linear-gradient(135deg,var(--warning),#d97706);color:#fff;box-shadow:var(--shadow);position:relative;z-index:2}
    .btn.warning:hover{background:linear-gradient(135deg,#d97706,#b45309);box-shadow:var(--shadow-lg);color:#fff}
    
    .muted{color:var(--muted)}
    .input-invalid{border-color:var(--danger)!important;box-shadow:0 0 0 3px rgba(239,68,68,0.1)!important}
    
    table{width:100%;border-collapse:collapse;margin-top:16px;background:#fff;border-radius:12px;overflow:hidden;box-shadow:var(--shadow);transition:all 0.3s ease} 
    th,td{border-bottom:1px solid var(--line);padding:16px 20px;transition:all 0.2s ease} 
    thead th{background:linear-gradient(135deg,#f8fafc,#e2e8f0);color:var(--primary-700);text-transform:uppercase;font-size:.8rem;letter-spacing:.05em;font-weight:700;position:relative}
    thead th::after{content:'';position:absolute;bottom:0;left:0;right:0;height:2px;background:linear-gradient(90deg,var(--primary),var(--success))}
    tbody tr{transition:all 0.2s ease}
    tbody tr:hover{background:linear-gradient(135deg,#f8fafc,#eff6ff);transform:scale(1.01)}
    tbody tr:last-child td{border-bottom:none}
    
    input,select{width:100%;padding:12px 16px;border:2px solid var(--line);border-radius:10px;font-size:14px;transition:all 0.3s ease;background:#fff}
    input:focus,select:focus{outline:none;border-color:var(--primary);box-shadow:0 0 0 4px rgba(59,130,246,0.1);transform:translateY(-1px)}
    input:hover,select:hover{border-color:var(--primary-700)}
    
    .form-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(250px,1fr));gap:20px}
    .row{display:flex;gap:16px;align-items:center;flex-wrap:wrap}
    .preview{width:80px;height:80px;border-radius:50%;object-fit:cover;background:linear-gradient(135deg,#e2e8f0,#cbd5e1);border:4px solid #fff;box-shadow:var(--shadow-lg);transition:all 0.3s ease}
    .preview:hover{transform:scale(1.1);box-shadow:var(--shadow-xl)}
    
    .admin-tabs{display:flex;gap:4px;margin-bottom:32px;background:linear-gradient(135deg,#f1f5f9,#e2e8f0);padding:6px;border-radius:16px;box-shadow:var(--shadow-sm)}
    .admin-tabs .tab{border:none;padding:14px 24px;cursor:pointer;font-weight:600;color:var(--muted);background:transparent;border-radius:12px;transition:all 0.3s ease;position:relative;overflow:hidden}
    .admin-tabs .tab::before{content:'';position:absolute;top:0;left:0;right:0;bottom:0;background:linear-gradient(135deg,var(--primary),var(--success));opacity:0;transition:opacity 0.3s ease}
    .admin-tabs .tab.active{background:#fff;color:var(--primary-700);box-shadow:var(--shadow);transform:translateY(-1px)}
    .admin-tabs .tab.active::before{opacity:0.1}
    .admin-tabs .tab:hover{transform:translateY(-1px);color:var(--primary-700)}
    
    .login-box{max-width:420px;margin:0 auto;text-align:center;padding:48px;border-radius:20px;box-shadow:var(--shadow-xl);background:#fff;position:relative;overflow:hidden}
    .login-box::before{content:'';position:absolute;top:0;left:0;right:0;height:6px;background:linear-gradient(90deg,var(--primary),var(--success),var(--warning))}

    /* Header - Integrado del index.html */
    .site-header{position:fixed;top:0;left:0;right:0;z-index:3000;background:rgba(255,255,255,0.95);backdrop-filter:blur(10px);border-bottom:1px solid var(--line);box-shadow:var(--shadow-sm)}
    .topbar{display:flex;align-items:center;justify-content:space-between;padding:8px 20px;border-bottom:1px solid var(--line);overflow:visible}
    .topbar-left{display:flex;gap:12px;align-items:center}
    .topbar-right{display:flex;gap:16px;align-items:center;position:relative;overflow:visible}

    .icon{width:20px;height:20px;display:inline-block;vertical-align:middle;transition:all 0.3s ease}
    .icon svg{width:100%;height:100%}
    .sr-only{position:absolute;width:1px;height:1px;padding:0;margin:-1px;overflow:hidden;clip:rect(0,0,0,0);white-space:nowrap;border:0}
    .link-icon{display:inline-flex;align-items:center;gap:8px;color:var(--muted);text-decoration:none;font-size:.9rem;padding:8px 12px;border-radius:8px;transition:all 0.3s ease}
    .link-icon:hover{color:var(--primary);background:var(--primary-50);transform:translateY(-1px)}

    /* Navbar responsive */
    .navbar{display:grid;grid-template-columns:1fr auto 1fr;align-items:center;padding:12px 20px;background:rgba(255,255,255,0.8)}
    .hamb{display:none;background:linear-gradient(135deg,var(--primary),var(--success));color:#fff;border:none;border-radius:10px;padding:10px 16px;font-weight:600;transition:all 0.3s ease}
    .hamb:hover{transform:translateY(-2px);box-shadow:var(--shadow-lg)}
    .menu{display:flex;gap:24px;align-items:center;justify-content:flex-start;position:relative}
    .menu a{color:var(--primary-700);text-decoration:none;font-weight:600;padding:8px 16px;border-radius:8px;transition:all 0.3s ease;position:relative}
    .menu a:hover{background:var(--primary-50);color:var(--primary);transform:translateY(-1px)}
    .logo{display:flex;justify-content:center;transition:all 0.3s ease}
    .logo img{height:100px;width:100px;border-radius:50%;box-shadow:var(--shadow);transition:all 0.3s ease;border:4px solid #fff}
    .logo:hover img{transform:scale(1.05);box-shadow:var(--shadow-lg)}
    .header-spacer{height:160px}

    /* Dropdown + hover */
    .nav-item{position:relative}
    .nav-item>a,.nav-item>button{all:unset;cursor:pointer;color:var(--primary-700);font-weight:600;padding:8px 16px;border-radius:8px;transition:all 0.3s ease;position:relative}
    .nav-item>a:hover,.nav-item>button:hover{background:var(--primary-50);color:var(--primary);transform:translateY(-1px)}
    .nav-item.has-sub>button .chev{display:inline-block;transform:rotate(0deg);transition:transform .3s ease;margin-left:4px}
    .nav-item.has-sub.open>button .chev{transform:rotate(90deg)}
    .submenu{display:none;position:absolute;top:40px;left:0;background:#fff;border:1px solid var(--line);box-shadow:var(--shadow-xl);border-radius:16px;padding:12px;min-width:240px;z-index:5000;animation:slideDown 0.3s ease}
    @keyframes slideDown{from{opacity:0;transform:translateY(-10px)}to{opacity:1;transform:translateY(0)}}
    .submenu a{display:block;padding:12px 16px;border-radius:10px;color:var(--text);text-decoration:none;transition:all 0.2s ease;font-weight:500}
    .submenu a:hover{background:linear-gradient(135deg,var(--primary-50),#eff6ff);color:var(--primary);transform:translateX(4px)}
    .nav-item.has-sub.open>.submenu{display:block}
    @media(hover:hover) and (pointer:fine){ .nav-item.has-sub:hover>.submenu{display:block} }

    /* Alinear el menú de Cuenta al borde derecho del botón */
    #nav-user{position:relative;margin-left:8px}
    #nav-user .submenu{right:0;left:auto;top:40px}

    /* Mobile */
    @media(max-width:900px){ .logo img{height:90px;width:90px} .header-spacer{height:152px} }
    @media(max-width:720px){
      .navbar{grid-template-columns:auto 1fr auto}
      .hamb{display:inline-flex;align-items:center;gap:8px;background:linear-gradient(135deg,var(--primary),var(--success));color:#fff;border:none;border-radius:10px;padding:10px 16px;font-weight:600;transition:all 0.3s ease}
      .menu{display:none;position:absolute;top:132px;left:0;right:0;background:rgba(255,255,255,0.98);backdrop-filter:blur(10px);border-top:1px solid var(--line);padding:16px;flex-direction:column;gap:8px;z-index:3050;box-shadow:var(--shadow-lg)}
      .menu.open{display:flex;animation:slideDown 0.3s ease}
      .logo{grid-column:2}
      .topbar{flex-wrap:wrap;gap:8px}
      .topbar-right{margin-left:auto}
      .submenu{position:static;border:none;box-shadow:none;margin-top:8px;background:var(--primary-50);border-radius:10px}
      #nav-user .submenu{position:static;right:auto;left:auto;top:auto}
    }

    header.hero{background:linear-gradient(135deg,var(--primary) 0%,var(--success) 50%,var(--warning) 100%);color:#fff;padding:40px 20px;text-align:center;margin-bottom:32px;position:relative;overflow:hidden}
    header.hero::before{content:'';position:absolute;top:0;left:0;right:0;bottom:0;background:url('data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100"><defs><pattern id="grain" width="100" height="100" patternUnits="userSpaceOnUse"><circle cx="25" cy="25" r="1" fill="white" opacity="0.1"/><circle cx="75" cy="75" r="1" fill="white" opacity="0.1"/><circle cx="50" cy="10" r="0.5" fill="white" opacity="0.1"/><circle cx="10" cy="60" r="0.5" fill="white" opacity="0.1"/><circle cx="90" cy="40" r="0.5" fill="white" opacity="0.1"/></pattern></defs><rect width="100" height="100" fill="url(%23grain)"/></svg>') repeat;opacity:0.3}
    header.hero h1{position:relative;z-index:1;font-size:2.5rem;font-weight:800;margin:0;text-shadow:0 2px 4px rgba(0,0,0,0.1)}
    header.hero p{position:relative;z-index:1;font-size:1.2rem;opacity:0.9;margin:12px 0 0 0}
    @media print{ .site-header,.btn,.hamb,.menu{display:none!important}; .card{box-shadow:none;border:0} header.hero{background:#fff;color:#000;border-bottom:2px solid #e5e7eb} }
  
    /* RESPONSIVE PATCH */
    .topbar-right{ position:relative; overflow:visible; }
    #nav-user{ position:relative; }
    #nav-user .submenu{ right:0; left:auto; top:40px; z-index:5000; }
    @media (max-width: 1200px){
      .navbar{ grid-template-columns: auto 1fr auto !important; }
    }
    @media (max-width: 1024px){
      .logo img{ height:90px; width:90px; }
      .header-spacer{ height:152px; }
    }
    @media (max-width: 900px){
      .menu{ display:none !important; position:absolute; top:132px; left:0; right:0; background:rgba(255,255,255,0.98); backdrop-filter:blur(10px); border-top:1px solid #e5e7eb; padding:16px; flex-direction:column; gap:8px; z-index:3050; box-shadow:var(--shadow-lg); }
      .menu.open{ display:flex !important; animation:slideDown 0.3s ease; }
    }
    @media (max-width: 720px){
      #nav-user .submenu{ position:static; right:auto; left:auto; top:auto; }
    }

    /* Panel Estudiantes */
    .sheet{border:1px solid var(--line);border-radius:16px;padding:24px;background:#fff;box-shadow:var(--shadow);transition:all 0.3s ease}
    .sheet:hover{box-shadow:var(--shadow-lg)}

    /* Mejoras visuales para admin */
    .admin-panel{background:#fff;border-radius:20px;box-shadow:var(--shadow-xl);overflow:hidden;position:relative}
    .admin-panel::before{content:'';position:absolute;top:0;left:0;right:0;height:6px;background:linear-gradient(90deg,var(--primary),var(--success),var(--warning))}
    
    .section-header{display:flex;justify-content:space-between;align-items:flex-start;margin-bottom:24px;padding-bottom:16px;border-bottom:3px solid var(--primary-50);position:relative}
    .section-header::after{content:'';position:absolute;bottom:-3px;left:0;width:60px;height:3px;background:linear-gradient(90deg,var(--primary),var(--success))}
    .section-header h2{margin:0;color:var(--primary-700);font-size:1.75rem;font-weight:700;position:relative}
    .section-header h2::before{content:'';position:absolute;left:-20px;top:50%;transform:translateY(-50%);width:4px;height:24px;background:linear-gradient(135deg,var(--primary),var(--success));border-radius:2px}
    .section-header p{margin:8px 0 0 0;color:var(--muted);font-size:1rem}
    
    .stats-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(220px,1fr));gap:20px;margin-bottom:32px}
    .stat-card{background:linear-gradient(135deg,#fff 0%,#f8fafc 100%);padding:24px;border-radius:16px;text-align:center;border:1px solid var(--line);box-shadow:var(--shadow);transition:all 0.3s ease;position:relative;overflow:hidden}
    .stat-card::before{content:'';position:absolute;top:0;left:0;right:0;height:4px;background:linear-gradient(90deg,var(--primary),var(--success))}
    .stat-card:hover{transform:translateY(-4px);box-shadow:var(--shadow-lg)}
    .stat-number{font-size:2.5rem;font-weight:800;color:var(--primary);margin-bottom:8px;background:linear-gradient(135deg,var(--primary),var(--success));-webkit-background-clip:text;-webkit-text-fill-color:transparent;background-clip:text;animation:countUp 0.8s ease-out}
    .stat-label{color:var(--muted);font-size:0.9rem;text-transform:uppercase;letter-spacing:0.1em;font-weight:600}
    
    @keyframes countUp{from{opacity:0;transform:translateY(20px)}to{opacity:1;transform:translateY(0)}}
    @keyframes fadeInUp{from{opacity:0;transform:translateY(30px)}to{opacity:1;transform:translateY(0)}}
    @keyframes pulse{0%,100%{transform:scale(1)}50%{transform:scale(1.05)}}
    @keyframes shimmer{0%{background-position:-200px 0}100%{background-position:calc(200px + 100%) 0}}
    
    /* Loading states */
    .loading{position:relative;overflow:hidden}
    .loading::after{content:'';position:absolute;top:0;left:0;right:0;bottom:0;background:linear-gradient(90deg,transparent,rgba(255,255,255,0.4),transparent);animation:shimmer 1.5s infinite}
    
    /* Enhanced form elements */
    .form-group{position:relative;margin-bottom:20px}
    .form-group label{display:block;margin-bottom:8px;font-weight:600;color:var(--text);font-size:0.9rem}
    .form-group input,.form-group select{transition:all 0.3s ease}
    .form-group input:focus,.form-group select:focus{transform:translateY(-2px);box-shadow:0 8px 25px rgba(59,130,246,0.15)}
    
    /* Enhanced buttons */
    .btn-group{display:flex;gap:8px;flex-wrap:wrap}
    .btn-sm{padding:8px 12px;font-size:0.85rem;position:relative;z-index:2}
    .btn-lg{padding:16px 24px;font-size:1.1rem;position:relative;z-index:2}
    
    /* Botones en tablas */
    .table-actions .btn{position:relative;z-index:2}
    .table-actions .btn:hover{color:inherit}
    
    /* Estilos para el formulario de estudiantes */
    .preview{width:80px;height:80px;border-radius:50%;object-fit:cover;background:linear-gradient(135deg,#e2e8f0,#cbd5e1);border:4px solid #fff;box-shadow:var(--shadow-lg);transition:all 0.3s ease}
    .preview:hover{transform:scale(1.1);box-shadow:var(--shadow-xl)}
    
    /* Estilos para secciones del formulario */
    .form-section{background:#f8fafc;border-radius:12px;border:1px solid var(--line);padding:20px;margin:16px 0}
    .form-section h4{margin:0 0 16px 0;color:var(--primary-700);font-size:1.1rem;display:flex;align-items:center;gap:8px}
    .form-section h4::before{content:'';width:4px;height:20px;background:linear-gradient(135deg,var(--primary),var(--success));border-radius:2px}
    
    /* Status indicators */
    .status{display:inline-flex;align-items:center;gap:6px;padding:4px 12px;border-radius:20px;font-size:0.8rem;font-weight:600;text-transform:uppercase;letter-spacing:0.05em}
    .status.active{background:rgba(16,185,129,0.1);color:var(--success);border:1px solid rgba(16,185,129,0.2)}
    .status.inactive{background:rgba(239,68,68,0.1);color:var(--danger);border:1px solid rgba(239,68,68,0.2)}
    .status.pending{background:rgba(245,158,11,0.1);color:var(--warning);border:1px solid rgba(245,158,11,0.2)}
    
    /* Enhanced cards */
    .card-header{display:flex;align-items:center;justify-content:space-between;padding-bottom:16px;margin-bottom:20px;border-bottom:2px solid var(--primary-50)}
    .card-title{margin:0;color:var(--primary-700);font-size:1.25rem;font-weight:700}
    .card-subtitle{margin:4px 0 0 0;color:var(--muted);font-size:0.9rem}
    
    /* Progress bars */
    .progress{width:100%;height:8px;background:var(--line);border-radius:4px;overflow:hidden;margin:8px 0}
    .progress-bar{height:100%;background:linear-gradient(90deg,var(--primary),var(--success));transition:width 0.3s ease;border-radius:4px}
    
    /* Tooltips */
    .tooltip{position:relative;cursor:help}
    .tooltip::after{content:attr(data-tooltip);position:absolute;bottom:100%;left:50%;transform:translateX(-50%);background:var(--text);color:#fff;padding:8px 12px;border-radius:6px;font-size:0.8rem;white-space:nowrap;opacity:0;visibility:hidden;transition:all 0.3s ease;z-index:1000}
    .tooltip:hover::after{opacity:1;visibility:visible;transform:translateX(-50%) translateY(-4px)}
    
    /* Enhanced tables */
    .table-container{overflow-x:auto;border-radius:12px;box-shadow:var(--shadow)}
    .table-actions{display:flex;gap:4px;flex-wrap:wrap}
    .table-actions .btn{font-size:0.8rem;padding:6px 10px}
    
    /* Notifications */
    .notification{position:fixed;top:20px;right:20px;background:#fff;border:1px solid var(--line);border-radius:12px;box-shadow:var(--shadow-xl);padding:16px 20px;min-width:300px;z-index:10000;transform:translateX(100%);transition:transform 0.3s ease}
    .notification.show{transform:translateX(0)}
    .notification.success{border-left:4px solid var(--success)}
    .notification.error{border-left:4px solid var(--danger)}
    .notification.warning{border-left:4px solid var(--warning)}
    
    /* Mobile enhancements */
    @media (max-width: 768px){
      .stats-grid{grid-template-columns:repeat(2,1fr);gap:12px}
      .stat-card{padding:16px}
      .stat-number{font-size:2rem}
      .btn-group{flex-direction:column}
      .btn-group .btn{width:100%}
      .table-container{font-size:0.85rem}
      .card{padding:16px}
    }
    
    /* Dark mode support */
    @media (prefers-color-scheme: dark){
      :root{
        --bg:#0f172a;
        --card:#1e293b;
        --text:#f1f5f9;
        --muted:#94a3b8;
        --line:#334155;
      }
      .card{background:var(--card);border-color:var(--line)}
      .btn{background:var(--card);color:var(--text);border-color:var(--line)}
      input,select{background:var(--card);color:var(--text);border-color:var(--line)}
      table{background:var(--card)}
      thead th{background:linear-gradient(135deg,#1e293b,#334155)}
    }
  </style>
  <script>
    function setupHeader(){
      // Menú hamburguesa
      const hamb=document.getElementById('hamb');
      const navMenu=document.getElementById('mainMenu');
      if(hamb&&navMenu){
        hamb.addEventListener('click',(e)=>{e.stopPropagation();navMenu.classList.toggle('open');});
      }
      // Desplegables
      const dropdowns=document.querySelectorAll('.nav-item.has-sub');
      dropdowns.forEach(drop=>{
        const btn=drop.querySelector('button');
        if(btn){
          btn.addEventListener('click',(e)=>{
            e.stopPropagation();
            const wasOpen=drop.classList.contains('open');
            dropdowns.forEach(d=>d.classList.remove('open'));
            if(!wasOpen) drop.classList.add('open');
          });
        }
      });
      document.addEventListener('click',()=>{ if(navMenu) navMenu.classList.remove('open'); dropdowns.forEach(d=>d.classList.remove('open')); });
    }
    document.addEventListener('DOMContentLoaded',setupHeader);
  </script>
</head>
<body>

  <div class="site-header">
    <div class="topbar">
      <div class="topbar-left">
        <button class="hamb" id="hamb" aria-label="Abrir menú">
          <span class="icon"><svg viewBox="0 0 24 24" fill="currentColor"><path d="M3 6h18v2H3zm0 5h18v2H3zm0 5h18v2H3z"/></svg></span><span>Menú</span>
        </button>
      </div>
      <div class="topbar-right">
        <a class="link-icon" href="#" aria-label="Facebook"><span class="icon"><svg viewBox="0 0 24 24" fill="currentColor"><path d="M22 12a10 10 0 1 0-11.6 9.9v-7h-2v-3h2v-2.3c0-2 1.2-3.1 3-3.1.9 0 1.8.1 1.8.1v2h-1c-1 0-1.3.7-1.3 1.2V12h2.3l-.4 3h-1.9v7A10 10 0 0 0 22 12z"/></svg></span><span class="sr-only">Facebook</span></a>
        <a class="link-icon" href="#" aria-label="LinkedIn"><span class="icon"><svg viewBox="0 0 24 24" fill="currentColor"><path d="M4.98 3.5C4.98 4.88 3.86 6 2.5 6S0 4.88 0 3.5 1.12 1 2.5 1 4.98 2.12 4.98 3.5zM0 8h5v16H0zM8 8h4.8v2.2h.1c.7-1.2 2.3-2.5 4.8-2.5 5.1 0 6 3.3 6 7.6V24h-5v-7.5c0-1.8 0-4.1-2.5-4.1-2.5 0-2.9 2-2.9 4v7.6H8z"/></svg></span><span class="sr-only">LinkedIn</span></a>
        <a class="link-icon" href="#" aria-label="Instagram"><span class="icon"><svg viewBox="0 0 24 24" fill="currentColor"><path d="M7 2h10a5 5 0 0 1 5 5v10a5 5 0 0 1-5 5H7a5 5 0 0 1-5-5V7a5 5 0 0 1 5-5zm5 5a5 5 0 1 0 0 10 5 5 0 0 0 0-10zm6.5-.9a1.1 1.1 0 1 0 0 2.2 1.1 1.1 0 0 0 0-2.2zM12 9a3 3 0 1 1 0 6 3 3 0 0 1 0-6z"/></svg></span><span class="sr-only">Instagram</span></a>
        <a class="link-icon" href="#" aria-label="TikTok"><span class="icon"><svg viewBox="0 0 24 24" fill="currentColor"><path d="M21 7.2c-2 0-3.8-.7-5.2-2.1V16a6 6 0 1 1-6-6c.4 0 .7 0 1 .1v3.5a3 3 0 1 0 2 2.8V1h3.2c.4 1.9 2.2 3.4 4.1 3.6V7.2z"/></svg></span><span class="sr-only">TikTok</span></a>

        <!-- Cuenta (dropdown; el contenido lo rellena auth.js) -->
        <div id="nav-user" class="nav-item has-sub">
          <button><span id="nav-username">Cuenta</span> <span class="chev">▾</span></button>
          <div class="submenu" id="accountMenu" style="min-width:200px"></div>
        </div>
      </div>
    </div>

    <div class="navbar">
      <nav id="mainMenu" class="menu">
        <a href="index.html">Inicio</a>
        <div class="nav-item has-sub">
          <button data-menu-id="institucion">Institución <span class="chev">▾</span></button>
          <div class="submenu">
            <a href="nosotros.html">Nosotros</a>
            <a href="programa.html">Programa</a>
            <a href="convenios.html">Convenios</a>
            <a href="contacto.html">Contacto</a>
          </div>
        </div>
        <a href="docentes.html">Docentes</a>
         <div class="nav-item has-sub">
          <button data-menu-id="Estudiantes">Estudiantes <span class="chev">▾</span></button>
          <div class="submenu">
            <a href="alumnos.html">Alumnos</a>
            <a href="exalumnos.html">Exalumnos</a>
          </div>
        </div>
              <a id="nav-admin" href="admin.html" style="display:none">Admin</a>
      </nav>
      <a class="logo" href="index.html"><img src="logo-tp.webp" alt="TP" /></a>
      <div></div>
    </div>
  </div>

  <div class="header-spacer"></div>

<header class="hero">
  <div style="position:relative;z-index:2">
    <h1>Panel de Administración</h1>
    <p style="margin:16px 0 0 0;opacity:0.9;font-size:1.2rem;max-width:600px;margin-left:auto;margin-right:auto">Gestión completa del sistema educativo con herramientas avanzadas</p>
    <div style="margin-top:24px;display:flex;gap:16px;justify-content:center;flex-wrap:wrap">
      <div style="display:flex;align-items:center;gap:8px;background:rgba(255,255,255,0.2);padding:8px 16px;border-radius:20px;backdrop-filter:blur(10px)">
        <span class="icon"><svg viewBox="0 0 24 24" fill="currentColor"><path d="M12 12c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm0 2c-2.67 0-8 1.34-8 4v2h16v-2c0-2.66-5.33-4-8-4z"/></svg></span>
        <span>Gestión de Estudiantes</span>
      </div>
      <div style="display:flex;align-items:center;gap:8px;background:rgba(255,255,255,0.2);padding:8px 16px;border-radius:20px;backdrop-filter:blur(10px)">
        <span class="icon"><svg viewBox="0 0 24 24" fill="currentColor"><path d="M12 2l3.09 6.26L22 9.27l-5 4.87 1.18 6.88L12 17.77l-6.18 3.25L7 14.14 2 9.27l6.91-1.01L12 2z"/></svg></span>
        <span>Control de Calificaciones</span>
      </div>
      <div style="display:flex;align-items:center;gap:8px;background:rgba(255,255,255,0.2);padding:8px 16px;border-radius:20px;backdrop-filter:blur(10px)">
        <span class="icon"><svg viewBox="0 0 24 24" fill="currentColor"><path d="M19 3H5c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2V5c0-1.1-.9-2-2-2zm-5 14H7v-2h7v2zm3-4H7v-2h10v2zm0-4H7V7h10v2z"/></svg></span>
        <span>Administración Completa</span>
      </div>
    </div>
  </div>
</header>

<div class="container">

  <!-- Login Form -->
  <div id="loginBox" class="card login-box" style="display:none">
    <div style="text-align:center;margin-bottom:32px">
      <div style="width:80px;height:80px;background:linear-gradient(135deg,var(--primary),var(--success));border-radius:50%;margin:0 auto 16px;display:flex;align-items:center;justify-content:center;box-shadow:var(--shadow-lg)">
        <span class="icon" style="width:40px;height:40px;color:#fff"><svg viewBox="0 0 24 24" fill="currentColor"><path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm-2 15l-5-5 1.41-1.41L10 14.17l7.59-7.59L19 8l-9 9z"/></svg></span>
      </div>
      <h2 style="margin:0;color:var(--primary-700);font-size:1.75rem">Acceso Administrativo</h2>
      <p style="margin:8px 0 0 0;color:var(--muted)">Ingresa tus credenciales para acceder al panel</p>
    </div>
    <form>
      <div style="margin-bottom:20px">
        <label for="email" style="display:block;margin-bottom:8px;font-weight:600;color:var(--text)">Correo Electrónico</label>
        <div style="position:relative">
          <span class="icon" style="position:absolute;left:16px;top:50%;transform:translateY(-50%);color:var(--muted)"><svg viewBox="0 0 24 24" fill="currentColor"><path d="M20 4H4c-1.1 0-1.99.9-1.99 2L2 18c0 1.1.9 2 2 2h16c1.1 0 2-.9 2-2V6c0-1.1-.9-2-2-2zm0 4l-8 5-8-5V6l8 5 8-5v2z"/></svg></span>
          <input type="email" id="email" placeholder="admin@liceo.cl" required style="width:100%;padding:12px 16px 12px 48px;border:2px solid var(--line);border-radius:10px;font-size:14px;transition:all 0.3s ease;background:#fff">
        </div>
      </div>
      <div style="margin-bottom:24px">
        <label for="pass" style="display:block;margin-bottom:8px;font-weight:600;color:var(--text)">Contraseña</label>
        <div style="position:relative">
          <span class="icon" style="position:absolute;left:16px;top:50%;transform:translateY(-50%);color:var(--muted)"><svg viewBox="0 0 24 24" fill="currentColor"><path d="M18 8h-1V6c0-2.76-2.24-5-5-5S7 3.24 7 6v2H6c-1.1 0-2 .9-2 2v10c0 1.1.9 2 2 2h12c1.1 0 2-.9 2-2V10c0-1.1-.9-2-2-2zm-6 9c-1.1 0-2-.9-2-2s.9-2 2-2 2 .9 2 2-.9 2-2 2zm3.1-9H8.9V6c0-1.71 1.39-3.1 3.1-3.1 1.71 0 3.1 1.39 3.1 3.1v2z"/></svg></span>
          <input type="password" id="pass" placeholder="••••••••" required style="width:100%;padding:12px 16px 12px 48px;border:2px solid var(--line);border-radius:10px;font-size:14px;transition:all 0.3s ease;background:#fff">
        </div>
      </div>
      <button type="submit" id="btnLogin" class="btn primary" style="width:100%;padding:16px;font-size:16px;font-weight:700;box-shadow:var(--shadow-lg)">
        <span class="icon"><svg viewBox="0 0 24 24" fill="currentColor"><path d="M11 7L9.6 8.4l2.6 2.6H2v2h10.2l-2.6 2.6L11 17l5-5-5-5zm9 12h-8v2h8c1.1 0 2-.9 2-2V5c0-1.1-.9-2-2-2h-8v2h8v12z"/></svg></span>
        Iniciar Sesión
      </button>
    </form>
    <div style="margin-top:24px;padding:16px;background:var(--primary-50);border-radius:10px;border-left:4px solid var(--primary)">
      <p style="margin:0;font-size:0.9rem;color:var(--primary-700)">
        <strong>Credenciales por defecto:</strong><br>
        Email: admin@liceo.cl<br>
        Contraseña: tp2025
      </p>
    </div>
  </div>

  <!-- Estadísticas del sistema -->
  <div id="statsPanel" class="stats-grid" style="display:none">
    <div class="stat-card">
      <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:16px">
        <div style="width:48px;height:48px;background:linear-gradient(135deg,var(--primary),var(--success));border-radius:12px;display:flex;align-items:center;justify-content:center;box-shadow:var(--shadow)">
          <span class="icon" style="width:24px;height:24px;color:#fff"><svg viewBox="0 0 24 24" fill="currentColor"><path d="M12 12c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm0 2c-2.67 0-8 1.34-8 4v2h16v-2c0-2.66-5.33-4-8-4z"/></svg></span>
        </div>
        <div style="text-align:right">
          <div style="font-size:0.8rem;color:var(--success);font-weight:600;display:flex;align-items:center;gap:4px">
            <span class="icon" style="width:12px;height:12px"><svg viewBox="0 0 24 24" fill="currentColor"><path d="M7 14l3-3 4 4 6-6 2 2-8 8-7-7z"/></svg></span>
            Activos
          </div>
        </div>
      </div>
      <div class="stat-number" id="totalStudents">0</div>
      <div class="stat-label">Estudiantes Registrados</div>
    </div>
    
    <div class="stat-card">
      <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:16px">
        <div style="width:48px;height:48px;background:linear-gradient(135deg,var(--warning),#f59e0b);border-radius:12px;display:flex;align-items:center;justify-content:center;box-shadow:var(--shadow)">
          <span class="icon" style="width:24px;height:24px;color:#fff"><svg viewBox="0 0 24 24" fill="currentColor"><path d="M19 3H5c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2V5c0-1.1-.9-2-2-2zm-5 14H7v-2h7v2zm3-4H7v-2h10v2zm0-4H7V7h10v2z"/></svg></span>
        </div>
        <div style="text-align:right">
          <div style="font-size:0.8rem;color:var(--warning);font-weight:600;display:flex;align-items:center;gap:4px">
            <span class="icon" style="width:12px;height:12px"><svg viewBox="0 0 24 24" fill="currentColor"><path d="M12 2l3.09 6.26L22 9.27l-5 4.87 1.18 6.88L12 17.77l-6.18 3.25L7 14.14 2 9.27l6.91-1.01L12 2z"/></svg></span>
            Configuradas
          </div>
        </div>
      </div>
      <div class="stat-number" id="totalSubjects">0</div>
      <div class="stat-label">Asignaturas Activas</div>
    </div>
    
    <div class="stat-card">
      <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:16px">
        <div style="width:48px;height:48px;background:linear-gradient(135deg,var(--success),#059669);border-radius:12px;display:flex;align-items:center;justify-content:center;box-shadow:var(--shadow)">
          <span class="icon" style="width:24px;height:24px;color:#fff"><svg viewBox="0 0 24 24" fill="currentColor"><path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm-2 15l-5-5 1.41-1.41L10 14.17l7.59-7.59L19 8l-9 9z"/></svg></span>
        </div>
        <div style="text-align:right">
          <div style="font-size:0.8rem;color:var(--success);font-weight:600;display:flex;align-items:center;gap:4px">
            <span class="icon" style="width:12px;height:12px"><svg viewBox="0 0 24 24" fill="currentColor"><path d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"/></svg></span>
            Egresados
          </div>
        </div>
      </div>
      <div class="stat-number" id="totalAlumni">0</div>
      <div class="stat-label">Ex-alumnos Registrados</div>
    </div>
    
    <div class="stat-card">
      <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:16px">
        <div style="width:48px;height:48px;background:linear-gradient(135deg,var(--danger),#dc2626);border-radius:12px;display:flex;align-items:center;justify-content:center;box-shadow:var(--shadow)">
          <span class="icon" style="width:24px;height:24px;color:#fff"><svg viewBox="0 0 24 24" fill="currentColor"><path d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"/></svg></span>
        </div>
        <div style="text-align:right">
          <div style="font-size:0.8rem;color:var(--primary);font-weight:600;display:flex;align-items:center;gap:4px">
            <span class="icon" style="width:12px;height:12px"><svg viewBox="0 0 24 24" fill="currentColor"><path d="M13 3c-4.97 0-9 4.03-9 9H1l3.89 3.89.07.14L9 12H6c0-3.87 3.13-7 7-7s7 3.13 7 7-3.13 7-7 7c-1.93 0-3.68-.79-4.94-2.06l-1.42 1.42C8.27 19.99 10.51 21 13 21c4.97 0 9-4.03 9-9s-4.03-9-9-9zm-1 5v5l4.28 2.54.72-1.21-3.5-2.08V8H12z"/></svg></span>
            Online
          </div>
        </div>
      </div>
      <div class="stat-number" id="activeUsers">0</div>
      <div class="stat-label">Usuarios Activos</div>
    </div>
  </div>

</div>

<div class="card admin-panel" id="adminPanel" style="display:none">
  <div class="admin-tabs">
    <button class="tab active" id="tab-general">General</button>
    <button class="tab" id="tab-exalumnos">Ex alumnos</button>
  </div>

  <section id="general">
    <div class="section-header">
      <h2>Gestión General</h2>
      <p class="muted">Administra estudiantes, asignaturas y calificaciones del sistema</p>
    </div>
    
    <div style="display:flex;gap:12px;flex-wrap:wrap;margin-bottom:24px">
      <button class="btn" id="tabStudents">
        <span class="icon"><svg viewBox="0 0 24 24" fill="currentColor"><path d="M12 12c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm0 2c-2.67 0-8 1.34-8 4v2h16v-2c0-2.66-5.33-4-8-4z"/></svg></span>
        Estudiantes
      </button>
      <button class="btn" id="tabSubjects">
        <span class="icon"><svg viewBox="0 0 24 24" fill="currentColor"><path d="M19 3H5c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2V5c0-1.1-.9-2-2-2zm-5 14H7v-2h7v2zm3-4H7v-2h10v2zm0-4H7V7h10v2z"/></svg></span>
        Asignaturas
      </button>
      <button class="btn" id="tabGrades">
        <span class="icon"><svg viewBox="0 0 24 24" fill="currentColor"><path d="M12 2l3.09 6.26L22 9.27l-5 4.87 1.18 6.88L12 17.77l-6.18 3.25L7 14.14 2 9.27l6.91-1.01L12 2z"/></svg></span>
        Calificaciones
      </button>
    </div>
    
    <section id="viewStudents" style="margin-top:12px">
      <div class="section-header">
        <h2>Estudiantes</h2>
        <button id="btnNew" class="btn primary">
          <span class="icon"><svg viewBox="0 0 24 24" fill="currentColor"><path d="M19 13h-6v6h-2v-6H5v-2h6V5h2v6h6v2z"/></svg></span>
          Nuevo Estudiante
        </button>
      </div>
      <div class="table-container">
        <table><thead><tr><th>Nombre</th><th>RUN</th><th>Curso</th><th>Programa</th><th>Usuario</th><th>Acciones</th></tr></thead><tbody id="rows"></tbody></table>
      </div>
    </section>
    
    <section id="viewSubjects" style="display:none;margin-top:12px">
      <div class="section-header">
        <h2>Asignaturas</h2>
        <button id="btnNewSubj" class="btn primary">
          <span class="icon"><svg viewBox="0 0 24 24" fill="currentColor"><path d="M19 13h-6v6h-2v-6H5v-2h6V5h2v6h6v2z"/></svg></span>
          Nueva Asignatura
        </button>
      </div>
      <div class="table-container">
        <table><thead><tr><th>Nombre</th><th>Nº Notas</th><th>Acciones</th></tr></thead><tbody id="rowsSubj"></tbody></table>
      </div>
    </section>
    
    <section id="viewGrades" style="display:none;margin-top:12px">
      <div class="section-header">
        <h2>Gestión de Calificaciones</h2>
        <p class="muted">Edita y gestiona las calificaciones de los estudiantes</p>
      </div>
      
      <div class="card" style="margin-bottom:20px">
        <h3 style="margin-top:0;color:var(--primary-700)">Seleccionar Estudiante y Asignatura</h3>
        <div style="display:flex;gap:12px;flex-wrap:wrap;align-items:end">
          <div style="flex:1;min-width:200px">
            <label for="selStudent" style="display:block;margin-bottom:4px;font-weight:600">Estudiante:</label>
            <select id="selStudent" style="width:100%;padding:10px;border:1px solid var(--line);border-radius:8px"></select>
          </div>
          <div style="flex:1;min-width:200px">
            <label for="selSubject" style="display:block;margin-bottom:4px;font-weight:600">Asignatura:</label>
            <select id="selSubject" style="width:100%;padding:10px;border:1px solid var(--line);border-radius:8px"></select>
          </div>
          <button id="btnLoad" class="btn primary">
            <span class="icon"><svg viewBox="0 0 24 24" fill="currentColor"><path d="M12 2l3.09 6.26L22 9.27l-5 4.87 1.18 6.88L12 17.77l-6.18 3.25L7 14.14 2 9.27l6.91-1.01L12 2z"/></svg></span>
            Cargar
          </button>
          <label class="btn" for="csvInput" style="cursor:pointer">
            <span class="icon"><svg viewBox="0 0 24 24" fill="currentColor"><path d="M14,2H6A2,2 0 0,0 4,4V20A2,2 0 0,0 6,22H18A2,2 0 0,0 20,20V8L14,2M18,20H6V4H13V9H18V20Z"/></svg></span>
            Importar CSV
          </label>
          <input id="csvInput" type="file" accept=".csv" style="display:none">
        </div>
      </div>
      
      <div id="gradesForm" class="card" style="display:none">
        <h3 style="margin-top:0;color:var(--primary-700)">Editar Calificaciones</h3>
        <div id="nInputs" style="display:grid;grid-template-columns:repeat(auto-fit,minmax(120px,1fr));gap:12px;margin-bottom:16px"></div>
        <div style="display:flex;gap:8px;justify-content:flex-end">
          <button id="btnSaveGrade" class="btn primary">
            <span class="icon"><svg viewBox="0 0 24 24" fill="currentColor"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"/></svg></span>
            Guardar Notas
          </button>
        </div>
      </div>
      
      <div class="card" style="background:#f8fafc;border:1px solid #e2e8f0">
        <h4 style="margin-top:0;color:var(--primary-700)">Formato CSV</h4>
        <p class="muted" style="margin-bottom:8px">Para importar calificaciones, usa el siguiente formato:</p>
        <code style="background:#fff;padding:8px 12px;border-radius:6px;border:1px solid #e5e7eb;display:inline-block">asignatura,N1,N2,N3,N4,N5</code>
      </div>
    </section>
  </section>

  <section id="exalumnos" style="display:none">
    <div class="section-header">
      <h2>Gestión de Ex-Alumnos</h2>
      <p class="muted">Administra la información de los ex-alumnos y sus registros profesionales</p>
    </div>
    
    <div class="card" style="margin-bottom:24px">
      <h3 style="margin-top:0;color:var(--primary-700)">Agregar/Editar Ex-Alumno</h3>
      <div class="form-grid">
        <div><label style="display:block;margin-bottom:4px;font-weight:600">Nombre Completo</label><input id="al-nombre" placeholder="Nombre completo" style="width:100%"></div>
        <div><label style="display:block;margin-bottom:4px;font-weight:600">Año de Egreso</label><input id="al-egreso" placeholder="2024" style="width:100%"></div>
        <div><label style="display:block;margin-bottom:4px;font-weight:600">Registro MINSAL (número)</label><input id="al-minsal-num" placeholder="123456" style="width:100%"></div>
        <div><label style="display:block;margin-bottom:4px;font-weight:600">Registro MINSAL (URL)</label><input id="al-minsal-url" placeholder="https://..." style="width:100%"></div>
        <div><label style="display:block;margin-bottom:4px;font-weight:600">Foto (subir archivo)</label><input id="al-foto-file" type="file" accept="image/*" style="width:100%"></div>
        <div><label style="display:block;margin-bottom:4px;font-weight:600">Foto (URL opcional)</label><input id="al-foto-url" placeholder="https://..." style="width:100%"></div>
      </div>
      
      <div class="row" style="margin-top:16px;align-items:center">
        <img id="al-preview" class="preview" alt="Vista previa" style="margin-right:16px">
        <div style="display:flex;gap:8px;flex-wrap:wrap">
          <button class="btn" id="al-clear">
            <span class="icon"><svg viewBox="0 0 24 24" fill="currentColor"><path d="M19,6.41L17.59,5L12,10.59L6.41,5L5,6.41L10.59,12L5,17.59L6.41,19L12,13.41L17.59,19L19,17.59L13.41,12L19,6.41Z"/></svg></span>
            Limpiar
          </button>
          <button class="btn primary" id="al-save">
            <span class="icon"><svg viewBox="0 0 24 24" fill="currentColor"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"/></svg></span>
            Guardar / Crear
          </button>
        </div>
      </div>
    </div>
    
    <div class="card" style="margin-bottom:20px">
      <h3 style="margin-top:0;color:var(--primary-700)">Filtros de Búsqueda</h3>
      <div class="row" style="align-items:end">
        <div style="flex:1;min-width:200px">
          <label for="al-find" style="display:block;margin-bottom:4px;font-weight:600">Buscar por nombre:</label>
          <input id="al-find" placeholder="Escribe el nombre..." style="width:100%">
        </div>
        <div style="min-width:120px">
          <label for="al-year" style="display:block;margin-bottom:4px;font-weight:600">Año:</label>
          <input id="al-year" placeholder="2024" style="width:100%">
        </div>
        <button class="btn" id="al-clear-filter">
          <span class="icon"><svg viewBox="0 0 24 24" fill="currentColor"><path d="M19,6.41L17.59,5L12,10.59L6.41,5L5,6.41L10.59,12L5,17.59L6.41,19L12,13.41L17.59,19L19,17.59L13.41,12L19,6.41Z"/></svg></span>
          Limpiar Filtros
        </button>
      </div>
    </div>
    
    <div class="card">
      <h3 style="margin-top:0;color:var(--primary-700)">Lista de Ex-Alumnos</h3>
      <div class="table-container">
        <table id="al-table">
          <thead><tr><th>Foto</th><th>Nombre</th><th>Egreso</th><th>RNPI</th><th>Acciones</th></tr></thead>
          <tbody></tbody>
        </table>
      </div>
    </div>
  </section>
</div>

<dialog id="editStudent"><div class="sheet" style="padding:16px">
  <h3 id="edTitle">Estudiante</h3>
  <div style="display:grid;grid-template-columns:repeat(2,minmax(220px,1fr));gap:12px">
    <div><label>Foto</label><br><img id="edAvatar" class="avatar"><input type="file" id="edFile" accept="image/*"></div>
    <div><label>Nombre</label><input id="edNombre"></div>
    <div><label>RUN</label><input id="edRun"></div>
    <div><label>Curso</label><input id="edCurso"></div>
    <div><label>Programa</label><input id="edPrograma" value="Enfermería"></div>
    <div><label>Correo (público)</label><input id="edPubCorreo"></div>
    <div><label>Teléfono (privado)</label><input id="edPriFono"></div>
    <div><label>Dirección (privado)</label><input id="edPriDir"></div>
    <div style="grid-column:1/-1"><label>URL Certificado</label><input id="edPriCert"></div>
    <div><label>Alumno – Usuario</label><input id="edUserAl"></div>
    <div><label>Alumno – Clave</label><input id="edPassAl" type="password"></div>
    <div><label>Apoderado – Usuario</label><input id="edUserAp"></div>
    <div><label>Apoderado – Clave</label><input id="edPassAp" type="password"></div>
  </div>
  <div style="margin-top:10px;display:flex;gap:8px;justify-content:flex-end"><button id="edCancel" class="btn">Cancelar</button><button id="edSave" class="btn">Guardar</button></div>
</div></dialog>

</div>

<script type="module" src="students.js"></script>
<script type="module" src="auth.js"></script>
<script type="module">
import { initAuthUI } from "./auth.js";

  // --- Script de autenticación y lógica de la página ---
  document.addEventListener('DOMContentLoaded', async function() {
    // Importar las funciones necesarias
    const { listStudents, addStudent, updateStudent, removeStudent, listSubjects, addSubject, updateSubject, removeSubject, getGrade, setGrade } = await import('./students.js');
    const { initAuthUI, signIn } = await import('./auth.js');
    
    const $ = s => document.querySelector(s);
    const $$ = s => document.querySelectorAll(s);

    // Variables globales
    const loginBox = $('#loginBox');
    const adminPanel = $('#adminPanel');
    let editingId = null;
    // Adaptadores para compatibilidad con el HTML existente
    function getAlumniAll(){
      // Exalumnos = estudiantes que tienen 'egreso' definido (o true/año)
      const all = (listStudents && listStudents()) || [];
      return all.filter(s => s.egreso);
    }
    function upsertAlumn(obj){
      if(!obj) return;
      if(obj.id){ return updateStudent(obj.id, obj); }
      return addStudent(obj);
    }
    function deleteAlumn(id){
      return removeStudent(id);
    }
    

    // --- Lógica de la interfaz de usuario (Tabs, Menús) ---
    function setupHeader() {
      // Menú hamburguesa
      const hamb = $('#hamb');
      const navMenu = $('#mainMenu');
      if (hamb && navMenu) {
        hamb.addEventListener('click', (e) => { e.stopPropagation(); navMenu.classList.toggle('open'); });
      }
      // Desplegables
      const dropdowns = $$('.nav-item.has-sub');
      dropdowns.forEach(drop => {
        const btn = drop.querySelector('button');
        if (btn) {
          btn.addEventListener('click', (e) => {
            e.stopPropagation();
            const wasOpen = drop.classList.contains('open');
            dropdowns.forEach(d => d.classList.remove('open'));
            if (!wasOpen) drop.classList.add('open');
          });
        }
      });
      document.addEventListener('click', () => { 
        if (navMenu) navMenu.classList.remove('open');
        dropdowns.forEach(d => d.classList.remove('open'));
      });
    }

    // Tabs de admin
    const tGen = $('#tab-general'), tEx = $('#tab-exalumnos');
    const sGen = $('#general'), sEx = $('#exalumnos');
    if (tGen && tEx) {
      tGen.onclick = () => { tGen.classList.add('active'); tEx.classList.remove('active'); sGen.style.display = 'block'; sEx.style.display = 'none'; };
      tEx.onclick = () => { tEx.classList.add('active'); tGen.classList.remove('active'); sEx.style.display = 'block'; sGen.style.display = 'none'; };
    }

    // --- Lógica de Autenticación ---
    function requireAdmin(redirectUrl = 'login.html') {
      const session = getSession();
      if (!session || session.role !== 'admin') {
        location.href = redirectUrl;
        return false;
      }
      return true;
    }

    function checkAuth() {
      if (!requireAdmin()) {
        loginBox.style.display = 'block';
        adminPanel.style.display = 'none';
        document.getElementById('statsPanel').style.display = 'none';
      } else {
        loginBox.style.display = 'none';
        adminPanel.style.display = 'block';
        document.getElementById('statsPanel').style.display = 'grid';
        updateStats();
      }
    }

    function updateStats() {
      const students = listStudents() || [];
      const subjects = listSubjects() || [];
      const alumni = getAlumniAll() || [];
      
      document.getElementById('totalStudents').textContent = students.length;
      document.getElementById('totalSubjects').textContent = subjects.length;
      document.getElementById('totalAlumni').textContent = alumni.length;
      document.getElementById('activeUsers').textContent = students.filter(s => s.cuentas?.alumno?.user).length;
    }

    function doAdminLogin(e) {
      e.preventDefault();
      const email = $('#email').value.trim();
      const pass = $('#pass').value.trim();
      const ses = signIn(email, pass);
      if (ses && ses.role === 'admin') {
        checkAuth();
      } else {
        alert('Credenciales de administrador inválidas.');
      }
    }

    function getSession() {
      try { 
        return JSON.parse(sessionStorage.getItem('tp_session') || 'null'); 
      } catch { 
        return null; 
      }
    }

    const btnLogin = $('#btnLogin');
    if (btnLogin) {
      btnLogin.addEventListener('click', doAdminLogin);
      // Also handle form submission
      const form = btnLogin.closest('form');
      if (form) {
        form.addEventListener('submit', doAdminLogin);
      }
    }

    // --- Lógica del Panel de Ex Alumnos ---
    const fNombre = $('#al-nombre');
    const fEgreso = $('#al-egreso');
    const fNum = $('#al-minsal-num');
    const fUrl = $('#al-minsal-url');
    const fFotoF = $('#al-foto-file');
    const fFotoU = $('#al-foto-url');
    const prev = $('#al-preview');
    const btnSave = $('#al-save');
    const btnClr = $('#al-clear');
    const tableT = $('#al-table tbody');
    const fFind = $('#al-find');
    const fYear = $('#al-year');
    const btnCF = $('#al-clear-filter');

    function uuid() { return 'al_' + Math.random().toString(36).slice(2, 8); }
    function normalize(v) { return (v || '').toString().trim().toLowerCase(); }
    
    function validateRNPI(num) {
      const ok = /^[0-9]{4,10}$/.test((num || '').trim());
      if (!ok) return { ok: false, msg: 'RNPI: solo dígitos (4 a 10). Ej: 123456' };
      return { ok: true };
    }

    function renderTable(arr) {
      tableT.innerHTML = arr.map(a => `
        <tr>
          <td><img src="${a.avatarUrl || ''}" style="width:48px;height:48px;border-radius:50%;object-fit:cover;background:#e2e8f0"></td>
          <td>${a.nombre || '-'}</td>
          <td>${a.egreso || '-'}</td>
          <td>RNPI: ${a.rnpi?.numero || '-'} ${a.rnpi?.url ? '· <a href="' + a.rnpi.url + '" target="_blank">ver</a>' : ''}</td>
          <td>
            <button class="btn" data-act="edit" data-id="${a.id}">Editar</button>
            <button class="btn danger" data-act="del" data-id="${a.id}">Eliminar</button>
          </td>
        </tr>
      `).join('') || '<tr><td colspan="5" class="muted">Sin ex alumnos</td></tr>';
    }

    function loadAlumniTable() {
      const base = getAlumniAll() || [];
      const q = normalize(fFind?.value);
      const y = normalize(fYear?.value);
      const out = base.filter(a => {
        const okN = !q || normalize(a.nombre).includes(q);
        const okY = !y || normalize(a.egreso) === y;
        return okN && okY;
      });
      renderTable(out);
    }

    function clearForm() {
      editingId = null;
      fNombre.value = ''; fEgreso.value = ''; fNum.value = ''; fUrl.value = ''; fFotoU.value = ''; prev.src = '';
      if (fFotoF) fFotoF.value = '';
    }

    async function readFileAsDataURL(file) {
      return new Promise((res, rej) => {
        const fr = new FileReader();
        fr.onload = () => res(fr.result);
        fr.onerror = rej;
        fr.readAsDataURL(file);
      });
    }

    btnClr && (btnClr.onclick = clearForm);

    btnSave && (btnSave.onclick = async () => {
      const nombre = fNombre.value.trim();
      const egreso = fEgreso.value.trim();
      const num = fNum.value.trim();
      let url = fUrl.value.trim();
      let avatar = fFotoU.value.trim() || prev.src || '';
      
      if (fFotoF && fFotoF.files && fFotoF.files[0]) {
        try { avatar = await readFileAsDataURL(fFotoF.files[0]); } catch (e) { console.error(e); }
      }

      if (!nombre) { alert('Nombre requerido'); return; }
      if (num && !validateRNPI(num).ok) { alert(validateRNPI(num).msg); return; }
      if (num && !url) url = "https://rnpi.superdesalud.gob.cl/#";

      const id = editingId || uuid();
      const obj = { id, nombre, egreso, avatarUrl: avatar, rnpi: { numero: num, url } };
      upsertAlumn(obj);
      clearForm();
      loadAlumniTable(); renderStudentsTable(); renderSubjectsTable(); fillSelectors(); seedIfEmpty(); updateStats();
    });

    tableT && tableT.addEventListener('click', (e) => {
      const btn = e.target.closest('button[data-act]');
      if (!btn) return;
      const act = btn.getAttribute('data-act');
      const id = btn.getAttribute('data-id');
      const item = getAlumniAll().find(x => x.id === id);

      if (act === 'edit' && item) {
        editingId = id;
        fNombre.value = item.nombre || '';
        fEgreso.value = item.egreso || '';
        fNum.value = (item.rnpi && item.rnpi.numero) ? item.rnpi.numero : '';
        fUrl.value = (item.rnpi && item.rnpi.url) ? item.rnpi.url : '';
        fFotoU.value = '';
        prev.src = item.avatarUrl || '';
        window.scrollTo({ top: 0, behavior: 'smooth' });
      } else if (act === 'del') {
        if (confirm('¿Eliminar ex alumno?')) {
          deleteAlumn(id);
          loadAlumniTable(); renderStudentsTable(); renderSubjectsTable(); fillSelectors(); seedIfEmpty(); updateStats();
        }
      }
    });

    // Filtros
    fFind && fFind.addEventListener('input', loadAlumniTable);
    fYear && fYear.addEventListener('input', loadAlumniTable);
    btnCF && btnCF.addEventListener('click', () => { 
      if (fFind) fFind.value = ''; 
      if (fYear) fYear.value = ''; 
      loadAlumniTable(); renderStudentsTable(); renderSubjectsTable(); fillSelectors(); seedIfEmpty(); updateStats();
    });


    // --- Panel: Estudiantes ---
    const secStudents = $('#viewStudents');
    const rowsStu = $('#rows');
    const btnNewStu = $('#btnNew');
    let stuEditingId = null;
    function ensureStudentForm(){
      let form = secStudents.querySelector('#studentForm');
      if (!form){
        form = document.createElement('div');
        form.id = 'studentForm';
        form.className = 'card';
        form.style.marginTop = '12px';
        form.innerHTML = `
          <h3 style="margin-top:0;color:var(--primary-700)">${stuEditingId ? 'Editar Estudiante' : 'Nuevo Estudiante'}</h3>
          
          <!-- Sección de imagen de perfil -->
          <div style="margin-bottom:24px;padding:20px;background:var(--primary-50);border-radius:12px;border:1px solid var(--primary-200)">
            <h4 style="margin:0 0 16px 0;color:var(--primary-700);font-size:1.1rem">Imagen de Perfil</h4>
            <div style="display:flex;gap:20px;align-items:center;flex-wrap:wrap">
              <div style="position:relative">
                <img id="st-preview" class="preview" alt="Vista previa" style="width:100px;height:100px;border:3px solid #fff;box-shadow:var(--shadow-lg)">
                <button type="button" id="st-clear-img" class="btn" style="position:absolute;top:-8px;right:-8px;width:24px;height:24px;padding:0;border-radius:50%;background:var(--danger);color:#fff;font-size:12px;display:none">
                  ×
                </button>
              </div>
              <div style="flex:1;min-width:200px">
                <label for="st-avatar-file" class="btn" style="display:inline-flex;align-items:center;gap:8px;margin-bottom:8px;cursor:pointer">
                  <span class="icon"><svg viewBox="0 0 24 24" fill="currentColor"><path d="M14,2H6A2,2 0 0,0 4,4V20A2,2 0 0,0 6,22H18A2,2 0 0,0 20,20V8L14,2M18,20H6V4H13V9H18V20Z"/></svg></span>
                  Cargar Imagen
                </label>
                <input id="st-avatar-file" type="file" accept="image/*" style="display:none">
                <div style="font-size:0.85rem;color:var(--muted);margin-top:4px">O ingresa una URL:</div>
                <input id="st-avatar" placeholder="https://ejemplo.com/imagen.jpg" style="width:100%;margin-top:4px">
              </div>
            </div>
          </div>

          <!-- Información básica -->
          <div class="form-grid">
            <div><label>Nombre Completo<br><input id="st-nombre" placeholder="Nombre completo" required></label></div>
            <div><label>RUN<br><input id="st-run" placeholder="12.345.678-9"></label></div>
            <div><label>Curso<br><input id="st-curso" placeholder="4° Medio A"></label></div>
            <div><label>Programa<br><input id="st-programa" placeholder="TP Enfermería" value="TP Enfermería"></label></div>
            <div style="display:flex;align-items:center;gap:8px"><input type="checkbox" id="st-publico"><label for="st-publico">Visible en listado público</label></div>
            <div><label>Año egreso (opcional)<br><input id="st-egreso" placeholder="2024"></label></div>
          </div>

          <!-- Credenciales del alumno -->
          <div style="margin:24px 0;padding:20px;background:#f8fafc;border-radius:12px;border:1px solid var(--line)">
            <h4 style="margin:0 0 16px 0;color:var(--primary-700);font-size:1.1rem">Credenciales del Alumno</h4>
            <div class="form-grid">
              <div><label>Usuario (email)<br><input id="st-user-al" type="email" placeholder="alumno@ejemplo.com"></label></div>
              <div><label>Contraseña<br><input id="st-pass-al" type="password" placeholder="••••••••"></label></div>
            </div>
          </div>

          <!-- Credenciales del apoderado -->
          <div style="margin:24px 0;padding:20px;background:#f8fafc;border-radius:12px;border:1px solid var(--line)">
            <h4 style="margin:0 0 16px 0;color:var(--primary-700);font-size:1.1rem">Credenciales del Apoderado</h4>
            <div class="form-grid">
              <div><label>Usuario (email)<br><input id="st-user-ap" type="email" placeholder="apoderado@ejemplo.com"></label></div>
              <div><label>Contraseña<br><input id="st-pass-ap" type="password" placeholder="••••••••"></label></div>
            </div>
          </div>

          <div class="row" style="margin-top:16px">
            <button id="st-save" class="btn primary">Guardar</button>
            <button id="st-cancel" class="btn">Cancelar</button>
          </div>`;
        
        // Insertar antes de la tabla
        const table = secStudents.querySelector('.table-container');
        if (table) {
          secStudents.insertBefore(form, table);
        } else {
          secStudents.appendChild(form);
        }
        
        // handlers
        form.querySelector('#st-cancel').onclick = ()=>{ 
          stuEditingId=null; 
          form.remove(); 
        };

        // Manejo de carga de imagen
        const avatarFile = form.querySelector('#st-avatar-file');
        const avatarUrl = form.querySelector('#st-avatar');
        const preview = form.querySelector('#st-preview');
        const clearBtn = form.querySelector('#st-clear-img');

        // Función para leer archivo como data URL
        async function readFileAsDataURL(file) {
          return new Promise((resolve, reject) => {
            const reader = new FileReader();
            reader.onload = () => resolve(reader.result);
            reader.onerror = reject;
            reader.readAsDataURL(file);
          });
        }

        // Función para actualizar vista previa
        function updatePreview(src) {
          if (src) {
            preview.src = src;
            clearBtn.style.display = 'block';
          } else {
            preview.src = 'data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" width="100" height="100"><circle cx="50" cy="50" r="50" fill="%23e2e8f0"/></svg>';
            clearBtn.style.display = 'none';
          }
        }

        // Event listeners para imagen
        avatarFile.addEventListener('change', async (e) => {
          const file = e.target.files[0];
          if (file) {
            try {
              const dataURL = await readFileAsDataURL(file);
              updatePreview(dataURL);
              avatarUrl.value = ''; // Limpiar URL si se carga archivo
            } catch (error) {
              console.error('Error al cargar imagen:', error);
              alert('Error al cargar la imagen');
            }
          }
        });

        avatarUrl.addEventListener('input', (e) => {
          const url = e.target.value.trim();
          if (url) {
            updatePreview(url);
            avatarFile.value = ''; // Limpiar archivo si se ingresa URL
          } else if (!avatarFile.files[0]) {
            updatePreview('');
          }
        });

        clearBtn.addEventListener('click', () => {
          updatePreview('');
          avatarFile.value = '';
          avatarUrl.value = '';
        });

        form.querySelector('#st-save').onclick = async ()=>{
          const rec = {
            nombre: form.querySelector('#st-nombre').value.trim(),
            run: form.querySelector('#st-run').value.trim(),
            curso: form.querySelector('#st-curso').value.trim(),
            programa: form.querySelector('#st-programa').value.trim(),
            avatarUrl: form.querySelector('#st-avatar').value.trim() || preview.src,
            publico: !!form.querySelector('#st-publico').checked
          };

          // Agregar credenciales si están completas
          const userAl = form.querySelector('#st-user-al').value.trim();
          const passAl = form.querySelector('#st-pass-al').value.trim();
          const userAp = form.querySelector('#st-user-ap').value.trim();
          const passAp = form.querySelector('#st-pass-ap').value.trim();

          if (userAl && passAl) {
            rec.cuentas = rec.cuentas || {};
            rec.cuentas.alumno = { user: userAl, pass: passAl };
          }

          if (userAp && passAp) {
            rec.cuentas = rec.cuentas || {};
            rec.cuentas.apoderado = { user: userAp, pass: passAp };
          }

          const eg = form.querySelector('#st-egreso').value.trim();
          if (eg) rec.egreso = eg;

          if (!rec.nombre){ 
            alert('Nombre requerido'); 
            form.querySelector('#st-nombre').focus();
            return; 
          }

          try {
            if (stuEditingId){ 
              updateStudent(stuEditingId, rec); 
              alert('Estudiante actualizado correctamente');
            } else { 
              addStudent(rec); 
              alert('Estudiante creado correctamente');
            }
            stuEditingId=null;
            form.remove();
            renderStudentsTable(); 
            updateStats();
          } catch (error) {
            console.error('Error al guardar estudiante:', error);
            alert('Error al guardar el estudiante');
          }
        };
      }
      return form;
    }
    function fillStudentForm(s){
      const form = ensureStudentForm();
      if (form) {
        // Información básica
        form.querySelector('#st-nombre').value = s?.nombre || '';
        form.querySelector('#st-run').value = s?.run || '';
        form.querySelector('#st-curso').value = s?.curso || '';
        form.querySelector('#st-programa').value = s?.programa || 'TP Enfermería';
        form.querySelector('#st-publico').checked = !!s?.publico;
        form.querySelector('#st-egreso').value = s?.egreso || '';
        
        // Imagen de perfil
        const avatarUrl = form.querySelector('#st-avatar');
        const preview = form.querySelector('#st-preview');
        const clearBtn = form.querySelector('#st-clear-img');
        
        if (s?.avatarUrl) {
          avatarUrl.value = s.avatarUrl;
          preview.src = s.avatarUrl;
          clearBtn.style.display = 'block';
        } else {
          avatarUrl.value = '';
          preview.src = 'data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" width="100" height="100"><circle cx="50" cy="50" r="50" fill="%23e2e8f0"/></svg>';
          clearBtn.style.display = 'none';
        }
        
        // Credenciales del alumno
        form.querySelector('#st-user-al').value = s?.cuentas?.alumno?.user || '';
        form.querySelector('#st-pass-al').value = s?.cuentas?.alumno?.pass || '';
        
        // Credenciales del apoderado
        form.querySelector('#st-user-ap').value = s?.cuentas?.apoderado?.user || '';
        form.querySelector('#st-pass-ap').value = s?.cuentas?.apoderado?.pass || '';
        
        // Actualizar el título del formulario
        const title = form.querySelector('h3');
        if (title) {
          title.textContent = stuEditingId ? 'Editar Estudiante' : 'Nuevo Estudiante';
        }
      }
    }
    function renderStudentsTable(){
      const arr = (listStudents && listStudents()) || [];
      rowsStu.innerHTML = arr.map(s=>`
        <tr>
          <td>${s.nombre||'-'}</td>
          <td>${s.run||'-'}</td>
          <td>${s.curso||'-'}</td>
          <td>${s.programa||'-'}</td>
          <td>${s.cuentas?.alumno?.user || '-'}</td>
          <td>
            <div class="table-actions">
              <button class="btn btn-sm" data-act="edit-stu" data-id="${s.id}" data-tooltip="Editar estudiante">
                <span class="icon"><svg viewBox="0 0 24 24" fill="currentColor"><path d="M3 17.25V21h3.75L17.81 9.94l-3.75-3.75L3 17.25zM20.71 7.04c.39-.39.39-1.02 0-1.41l-2.34-2.34c-.39-.39-1.02-.39-1.41 0l-1.83 1.83 3.75 3.75 1.83-1.83z"/></svg></span>
                Editar
              </button>
              <button class="btn btn-sm success" data-act="grad-stu" data-id="${s.id}" data-tooltip="Marcar como egresado">
                <span class="icon"><svg viewBox="0 0 24 24" fill="currentColor"><path d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"/></svg></span>
                Egresar
              </button>
              <button class="btn btn-sm danger" data-act="del-stu" data-id="${s.id}" data-tooltip="Eliminar estudiante">
                <span class="icon"><svg viewBox="0 0 24 24" fill="currentColor"><path d="M19 6.41L17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"/></svg></span>
                Eliminar
              </button>
            </div>
          </td>
        </tr>
      `).join('') || '<tr><td colspan="6" class="muted">Sin estudiantes</td></tr>';
    }
    btnNewStu && (btnNewStu.onclick = ()=>{ 
      stuEditingId=null; 
      ensureStudentForm(); 
      fillStudentForm(null); 
      window.scrollTo({top:0, behavior:'smooth'}); 
    });
    secStudents && secStudents.addEventListener('click', (ev)=>{
      const btn = ev.target.closest('button[data-act]'); if(!btn) return;
      const id = btn.getAttribute('data-id');
      const act = btn.getAttribute('data-act');
      if (act==='edit-stu'){
        stuEditingId = id;
        const s = (listStudents()||[]).find(x=>x.id===id);
        ensureStudentForm(); fillStudentForm(s); window.scrollTo({top:0, behavior:'smooth'});
      } else if (act==='del-stu'){
        if (confirm('¿Eliminar estudiante?')){ removeStudent(id); renderStudentsTable(); updateStats(); }
      } else if (act==='grad-stu'){
        const anio = prompt('Año de egreso', new Date().getFullYear());
        if (anio){ updateStudent(id, {egreso: anio}); renderStudentsTable(); loadAlumniTable && loadAlumniTable(); renderStudentsTable(); renderSubjectsTable(); fillSelectors(); seedIfEmpty(); updateStats(); alert('Estudiante marcado como egresado.'); }
      }
    });

    // --- Panel: Asignaturas ---
    const secSubj = $('#viewSubjects');
    const rowsSubj = $('#rowsSubj');
    const btnNewSubj = $('#btnNewSubj');
    let subjEditingId = null;

    function ensureSubjForm(){
      let form = secSubj.querySelector('#subjForm');
      if (!form){
        form = document.createElement('div');
        form.id = 'subjForm';
        form.className = 'card';
        form.style.marginTop = '12px';
        form.innerHTML = `
          <div class="form-grid">
            <div><label>Nombre<br><input id="sj-nombre" placeholder="Ej. Biología"></label></div>
            <div><label>Nº de notas<br><input id="sj-ncount" type="number" min="1" max="10" value="5"></label></div>
          </div>
          <div class="row" style="margin-top:10px">
            <button id="sj-save" class="btn">Guardar</button>
            <button id="sj-cancel" class="btn">Cancelar</button>
          </div>`;
        secSubj.insertBefore(form, secSubj.querySelector('table'));
        form.querySelector('#sj-cancel').onclick = ()=>{ subjEditingId=null; form.remove(); };
        form.querySelector('#sj-save').onclick = ()=>{
          const nombre = form.querySelector('#sj-nombre').value.trim();
          const nCount = +form.querySelector('#sj-ncount').value;
          if (!nombre){ alert('Nombre requerido'); return; }
          if (nCount<1 || nCount>10){ alert('Nº de notas entre 1 y 10'); return; }
          if (subjEditingId){ updateSubject(subjEditingId, {nombre, nCount}); }
          else { addSubject({nombre, nCount}); }
          subjEditingId=null;
          form.remove();
          renderSubjectsTable(); updateStats();
        };
      }
      return form;
    }
    function fillSubjForm(s){ const f=ensureSubjForm(); f.querySelector('#sj-nombre').value=s?.nombre||''; f.querySelector('#sj-ncount').value=s?.nCount||5; }
    function renderSubjectsTable(){
      const arr = (listSubjects && listSubjects()) || [];
      rowsSubj.innerHTML = arr.map(s=>`
        <tr>
          <td>${s.nombre||'-'}</td>
          <td>${s.nCount||0}</td>
          <td>
            <div class="table-actions">
              <button class="btn btn-sm" data-act="edit-subj" data-id="${s.id}" data-tooltip="Editar asignatura">
                <span class="icon"><svg viewBox="0 0 24 24" fill="currentColor"><path d="M3 17.25V21h3.75L17.81 9.94l-3.75-3.75L3 17.25zM20.71 7.04c.39-.39.39-1.02 0-1.41l-2.34-2.34c-.39-.39-1.02-.39-1.41 0l-1.83 1.83 3.75 3.75 1.83-1.83z"/></svg></span>
                Editar
              </button>
              <button class="btn btn-sm danger" data-act="del-subj" data-id="${s.id}" data-tooltip="Eliminar asignatura">
                <span class="icon"><svg viewBox="0 0 24 24" fill="currentColor"><path d="M19 6.41L17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"/></svg></span>
                Eliminar
              </button>
            </div>
          </td>
        </tr>
      `).join('') || '<tr><td colspan="3" class="muted">Sin asignaturas</td></tr>';
    }
    btnNewSubj && (btnNewSubj.onclick = ()=>{ subjEditingId=null; ensureSubjForm(); fillSubjForm(null); window.scrollTo({top:0, behavior:'smooth'}); });
    secSubj && secSubj.addEventListener('click', (ev)=>{
      const btn = ev.target.closest('button[data-act]'); if(!btn) return;
      const id = btn.getAttribute('data-id');
      const act = btn.getAttribute('data-act');
      if (act==='edit-subj'){
        subjEditingId = id;
        const s = (listSubjects()||[]).find(x=>x.id===id);
        ensureSubjForm(); fillSubjForm(s); window.scrollTo({top:0, behavior:'smooth'});
      } else if (act==='del-subj'){
        if (confirm('¿Eliminar asignatura?')){ removeSubject(id); renderSubjectsTable(); updateStats(); }
      }
    });

    // --- Panel: Notas ---
    const secGrades = $('#viewGrades');
    const selStudent = $('#selStudent');
    const selSubject = $('#selSubject');
    const btnLoad = $('#btnLoad');
    const csvInput = $('#csvInput');
    const gradesForm = $('#gradesForm');
    const nInputs = $('#nInputs');
    const btnSaveGrade = $('#btnSaveGrade');

    function fillSelectors(){
      // estudiantes
      const st = (listStudents && listStudents()) || [];
      selStudent.innerHTML = st.map(s=>`<option value="${s.id}">${s.nombre||'(Sin nombre)'} — ${s.curso||''}</option>`).join('');
      // asignaturas
      const sb = (listSubjects && listSubjects()) || [];
      selSubject.innerHTML = sb.map(s=>`<option value="${s.id}" data-n="${s.nCount||5}">${s.nombre||'(Sin nombre)'}</option>`).join('');
    }
    function loadGradeForm(){
      const stuId = selStudent.value;
      const subjId = selSubject.value;
      if (!stuId || !subjId){ alert('Selecciona estudiante y asignatura'); return; }
      const subj = (listSubjects()||[]).find(s=>s.id===subjId);
      const rec = getGrade(stuId, subjId);
      const nCount = subj?.nCount || 5;
      nInputs.innerHTML = Array.from({length:nCount}).map((_,i)=>{
        const val = Array.isArray(rec?.n) ? (rec.n[i]||0) : 0;
        return `<div><label>N${i+1}<br><input type="number" step="0.1" min="1" max="7" value="${val}" data-idx="${i}" style="width:100px"></label></div>`;
      }).join('');
      gradesForm.style.display = 'block';
    }
    btnLoad && (btnLoad.onclick = loadGradeForm);
    btnSaveGrade && (btnSaveGrade.onclick = ()=>{
      const stuId = selStudent.value;
      const subjId = selSubject.value;
      const subj = (listSubjects()||[]).find(s=>s.id===subjId);
      const nCount = subj?.nCount || 5;
      const n = Array.from(nInputs.querySelectorAll('input[type=number]'))
        .sort((a,b)=> (+a.dataset.idx)-(+b.dataset.idx))
        .map(inp => Math.max(0, Math.min(7, parseFloat(inp.value)||0)))
        .slice(0, nCount);
      while (n.length < nCount) n.push(0);
      setGrade(stuId, subjId, { n });
      alert('Notas guardadas');
    });
    csvInput && (csvInput.onchange = async (ev)=>{
      const file = ev.target.files?.[0]; if(!file) return;
      const text = await file.text();
      const stuId = selStudent.value;
      const lines = text.split(/\r?\n/).filter(Boolean);
      for (const line of lines){
        const parts = line.split(',').map(x=>x.trim());
        const subjName = parts[0];
        const subj = (listSubjects()||[]).find(s=>s.nombre?.toLowerCase()===subjName?.toLowerCase());
        if (!subj) continue;
        const n = parts.slice(1).map(v=>Number(v||0));
        while(n.length < (subj.nCount||5)) n.push(0);
        setGrade(stuId, subj.id, { n: n.slice(0, subj.nCount||5) });
      }
      alert('CSV importado');
    });

    // --- Navegación dentro de "General": Estudiantes / Asignaturas / Notas ---
    const tabStudentsBtn = $('#tabStudents');
    const tabSubjectsBtn = $('#tabSubjects');
    const tabGradesBtn = $('#tabGrades');
    function showGeneralTab(which){
      const sV = (v)=> v ? 'block' : 'none';
      const isS = which==='students', isB = which==='subjects', isG = which==='grades';
      $('#viewStudents').style.display = sV(isS);
      $('#viewSubjects').style.display = sV(isB);
      $('#viewGrades').style.display = sV(isG);
    }
    tabStudentsBtn && (tabStudentsBtn.onclick = ()=> showGeneralTab('students'));
    tabSubjectsBtn && (tabSubjectsBtn.onclick = ()=> showGeneralTab('subjects'));
    tabGradesBtn && (tabGradesBtn.onclick = ()=> showGeneralTab('grades'));

    // --- Seed inicial si está vacío ---
    function seedIfEmpty(){
      const sbs = listSubjects();
      const sts = listStudents();
      if (!sbs.length){
        addSubject({nombre:'Anatomía', nCount:5});
        addSubject({nombre:'Bioquímica', nCount:5});
        addSubject({nombre:'Farmacología', nCount:5});
      }
      if (!sts.length){
        const a = addStudent({ nombre:'Ana Pérez', run:'12.345.678-9', curso:'4°A', programa:'TP Enfermería', publico:true });
        const b = addStudent({ nombre:'Luis Díaz', run:'10.111.222-3', curso:'4°B', programa:'TP Enfermería', publico:false });
        // Opcional: crear una nota de ejemplo
        const subj = listSubjects()[0];
        if (subj){ setGrade(a.id, subj.id, { n:[6.0,5.8,6.3,0,0] }); }
      }
    }
    
    // Inicialización
    setupHeader();
    checkAuth();
    loadAlumniTable(); renderStudentsTable(); renderSubjectsTable(); fillSelectors(); seedIfEmpty(); updateStats();
    initAuthUI();
  });
</script>
</body>
</html>